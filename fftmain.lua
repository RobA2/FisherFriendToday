ffta=LibStub("AceAddon-3.0"):NewAddon("FisherFriendToday","AceEvent-3.0","AceTimer-3.0")local a=LibStub:GetLibrary("LibDataBroker-1.1")local c,e=...local f=e.L;local g={{key='navT',type='toggle',title=f['Use TomTom for directions?'],tooltip=f['If deselected or if TomTom not installed, will use in-game Map Pins'],default=true},{key='announce',type='toggle',title=f['Announcement on startup/reset?'],default=true},{key='anndelay',type='menu',title=f['Startup Announcement Delay?'],default=10,options={{value=0,label='0 Seconds'},{value=5,label='5 Seconds'},{value=10,label='10 Seconds'},{value=20,label='20 Seconds'},{value=30,label='30 Seconds'},{value=60,label='60 Seconds'}},requires='announce'},{key='alert',type='toggle',title=f['Alert before Reset?'],default=true},{key='alerttime',type='menu',title=f['Minutes before Reset?'],default=5,options={{value=1,label='1 Minute'},{value=2,label='2 Minutes'},{value=5,label='5 Minutes'},{value=10,label='10 Minutes'}},requires='alert'},{key='adjshow',type='toggle',title=f['Cycle correction?'],tooltip=f['Only needed if the wrong Fisherfriend is showing'..'\n\n|cffffaaaa'..f['This should usually be off']..'|r'],default=false},{key='adjn',type='menu',title=f['FFT Calendar Offset?'],tooltip=f['This will offset the cycle if the server/addon are out of sync'..'\n\n|cffffaaaa'..f['This should usually be 0']..'|r'],default=0,options={{value=0,label='0'},{value=1,label='+1'},{value=2,label='+2'},{value=3,label='+3'},{value=4,label='+4'},{value=5,label='+5'}},requires='adjshow'}}e:RegisterSettings('FFTDB',g)e:RegisterSettingsSlash('/ffts','/ffto')local h="|cffff4400"local i="|cffffcccc"local j="|cff44ff00"local k={{646,34.00,50.00},{630,43.20,40.60},{641,53.40,72.80},{650,45.14,59.81},{634,90.60,10.60},{680,50.60,49.20},{619,44.68,61.97}}local l={2102,2097,2098,2099,2100,2101,1975}local m={}for n=1,7 do local genX=C_Reputation.GetFactionDataByID(l[n])local mapX=C_Map.GetMapInfo(k[n][1])table.insert(m,n,mapX.name.." - "..genX.name)end;mapX,genX=nil;local o=""SLASH_FFT1="/fft"local p=0;local function q(r)if r then r=strlower(r)end;if e:GetOption('adjshow')then p=e:GetOption('adjn')else p=0 end;ffta.fftR=C_UnitAuras.GetPlayerAuraBySpellID(1213439)if ffta.fftR then ffta.remixC=h.."Remix character! Fishing Unavailable"for n=1,7 do table.insert(m,n,ffta.remixC)end else ffta.remixC=j.."Remix check: Standard retail character! Thanks for all the fish!!! ;)"end;local s=C_AddOns.IsAddOnLoaded("TomTom")and e:GetOption('navT')local u=tonumber(C_DateAndTime.GetServerTimeLocal())local w=GetQuestResetTime()local x=SecondsToTime(w)local y=(u+w)/86400;local z=floor(1+math.fmod(y+p,6))local A=1+math.fmod(z+6,6)local B=date("%I:00 %p",time()+w+1)ffta.art=B;local C="|cffff99ffFFT: |r"if r=='m'or r=='mar'then z=7 end;if r=='n'or r=='next'or r=='na'then z=A;C="|cffff99ddNext: |r"end;o=tostring(m[z])local D="#"..k[z][1].." "..k[z][2].." "..k[z][3].." "..C..o;local E="|cffffff00|Hworldmap:"..k[z][1]..":"..k[z][2]*100 ..":"..k[z][3]*100 .."|h[|A:Waypoint-MapPin-ChatIcon:13:13:0:0|a "..o.."]|h|r"local function F()if ffta.fftR then return end;DEFAULT_CHAT_FRAME:AddMessage(E)if s then SlashCmdList.TOMTOM_WAY(D)end end;local G=h.."**[TomTom] not enabled/detected-FFT will use map pins**|r"if r==''or p>0 then if ffta.fftR then print(ffta.remixC)return end;if p>0 then print("|cffffaaffFF Today: [offset="..p.."]|r")else print("|cffddaaffFF Today:|r")end;print(E.."|cff00ddff Reset ["..B.."] in "..x.."|r")end;if r=='c'then C_Map.ClearUserWaypoint()end;if r=='w'or r=='way'or r=='m'or r=='mar'then F()end;if r=='n'or r=='next'then if ffta.fftR then print(ffta.remixC)return end;o=C..o;print("|cffff99ddFF Next:|r")F()end;if r=='a'then RaidNotice_AddMessage(RaidWarningFrame,"FF Today: "..o..". Reset ["..B.."]",ChatTypeInfo["RAID_WARNING"])end;if r=='na'then RaidNotice_AddMessage(RaidWarningFrame,"FF Next: "..o..". in "..x,ChatTypeInfo["RAID_WARNING"])o="|cffaaddffNext: |r"..o;print("|cffaaddffFF "..o.." in "..x.."|r")end;if r=='?'or r=='help'then print("|cffccffcc   ===FFT===   ver: "..C_AddOns.GetAddOnMetadata("FisherFriendToday","version").."|r")if ffta.fftR then print(i.."More options available in standard retail|r")else if not s then print(G)end;print(i.."/FFT|r - prints the current Fisherfriend and reset time|r")print(i.."/FFT W / way|r -set waypoint for current Fisherfriend|r")print(i.."/FFT N|r - waypoint for 'Next' ,'M' for Margoss or 'C' to clear the map pin|r")print("|cffaacccc/FFT A / NA - announcment for current/next Fisherfriend|r")end;print(i.."/FFT RN|r - Show release notes|r")print("|cffffcc88/FFTO or /FFTS - Open the options page|r")print("|Cffff88ff/RL - Reload interface|r")print(ffta.remixC)end;Gqrt=w;ffta:CancelTimer(ffta.TimerOne)if e:GetOption('alert')then AlertResetTime=e:GetOption('alerttime')*60;if Gqrt<=AlertResetTime then AlertResetTime=0 end;Gqrt=w-AlertResetTime else Gqrt=w;AlertResetTime="Unused"end;ffta.TimerOne=ffta:ScheduleTimer("TimerFeedback",Gqrt+2)if e:GetOption('announce')then ffta.adel=e:GetOption('anndelay')else ffta.adel=0 end;if r=='rn'then print(j.."FFT Version: "..C_AddOns.GetAddOnMetadata("FisherFriendToday","version").."|r")print(i.."Release Notes: "..C_AddOns.GetAddOnMetadata("FisherFriendToday","X-VerNotes").."|r")end;if r=='info'then print(j.."FFT Version: "..C_AddOns.GetAddOnMetadata("FisherFriendToday","version").."|r")print(i.."Release Notes: "..C_AddOns.GetAddOnMetadata("FisherFriendToday","X-VerNotes").."|r")print(ffta.remixC)local H=GetCurrentRegionName()local I=GetRealmName()print(" Region/Realm: "..H.."/"..I)v,b,d,t=GetBuildInfo()print(string.format("version = %s, build = %s, date = '%s', tocversion = %s.",v,b,d,t))local d=C_DateAndTime.GetCurrentCalendarTime()local J=CALENDAR_WEEKDAY_NAMES[d.weekday]local K=CALENDAR_FULLDATE_MONTH_NAMES[d.month]print(format("Realm time is %02d:%02d, %s, %d %s %d",d.hour,d.minute,J,d.monthDay,K,d.year))local L=SecondsToTime(ffta:TimeLeft(ffta.TimerOne))local M=SecondsToTime(ffta:TimeLeft(ffta.TimerD))print("Timer reset: "..L)print("Ann timer left: "..M)print("Announce Delay: "..ffta.adel)end end;ffta.AlertOnce=nil;function ffta:TimerD1()q("a")end;function ffta:TimerFeedback()if e:GetOption('alert')and not ffta.AlertOnce then print("|cffffcc88Reset Soon|r")q("na")ffta.AlertOnce=true else print("|cffcccc88Reset detected : New FisherFriendToday|r")q("a")q("")ffta.AlertOnce=nil end end;SlashCmdList["FFT"]=q;SLASH_RL1="/rl"SlashCmdList["RL"]=function()ReloadUI()end;local function N()function ffta:OnEnable()q("")if e:GetOption('announce')then ffta.TimerD=ffta:ScheduleTimer("TimerD1",ffta.adel)end end;local O=a:NewDataObject("FisherFriendToday",{type="data source",icon="Interface\\Icons\\Inv_misc_2h_draenorfishingpole_b_01",OnClick=function(P,Q)if Q=="LeftButton"then if IsShiftKeyDown()then q("m")else if IsControlKeyDown()then else q("w")end end else q("n")end end,label="FFT",text="FisherFriendToday"})local R=CreateFrame("frame")R:SetScript("OnUpdate",function(self,S)O.text=" "..o end)function O:OnTooltipShow()self:AddLine("Left click for current FFT waypoint")self:AddLine("Shift + Left click for Margoss")self:AddLine("Right click for next FFT waypoint")self:AddLine("|cffffcc88 /ffto for options|r")self:AddLine("|cffcccc88 /fft ? for help|r")self:AddLine("|cffcc8888 Reset time: "..ffta.art.."|r")self:AddLine("- - - - -")end;function O:OnEnter()GameTooltip:SetOwner(self,"ANCHOR_NONE")GameTooltip:SetPoint("TOPLEFT",self,"BOTTOMLEFT")GameTooltip:ClearLines()O.OnTooltipShow(GameTooltip)GameTooltip:Show()end;function O:OnLeave()GameTooltip:Hide()end end;N()