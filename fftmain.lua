FisherFriendToday=LibStub("AceAddon-3.0"):NewAddon("FisherFriendToday","AceConsole-3.0","AceEvent-3.0","AceTimer-3.0")local a=LibStub:GetLibrary("LibDataBroker-1.1")local b,c=...local d=c.L;local e={{key='navT',type='toggle',title=d['Use TomTom for directions?'],tooltip=d['If deselected or if TomTom not installed, will use in-game Map Pins'],default=true},{key='announce',type='toggle',title=d['Announcement on startup?'],tooltip=d['Turn the raid style announcement on/off'],default=true},{key='adjshow',type='toggle',title=d['Cycle correction?'],tooltip=d['Only needed if the wrong Fisherfriend is showing'..'\n\n|cffffaaaa'..d['This should usually be off']..'|r'],default=false},{key='adjn',type='menu',title=d['FFT Calendar Offset?'],tooltip=d['This will offset the cycle if the server/addon are out of sync'..'\n\n|cffffaaaa'..d['This should usually be 0']..'|r'],default=0,options={{value=0,label='0'},{value=1,label='1'},{value=2,label='2'},{value=3,label='3'},{value=4,label='4'},{value=5,label='5'}},requires='adjshow'}}c:RegisterSettings('FFTDB',e)c:RegisterSettingsSlash('/ffts','/ffto')local f={"Broken Shore - Impus","Azsuna - Ilyssia of the Waters","Val'sharah - Keeper Raynae","Highmountain - Akule Riverhorn","Stormheim - Corbyn","Suramar - Sha'leth","Dalaran - Conjurer Margoss"}local g={{646,34.00,50.00},{630,43.20,40.60},{641,53.40,72.80},{650,45.14,59.81},{634,90.60,10.60},{680,50.60,49.20},{619,44.68,61.97}}local h=""SLASH_FFT1="/fft"local i=0;local function j(k)if k then k=strlower(k)end;if c:GetOption('adjshow')then i=c:GetOption('adjn')else i=0 end;local l=C_AddOns.IsAddOnLoaded("TomTom")and c:GetOption('navT')local m=tonumber(C_DateAndTime.GetServerTimeLocal())local n=GetQuestResetTime()local o=SecondsToTime(n)local p=(m+n)/86400;local q=floor(1+math.fmod(p+i,6))local r=1+math.fmod(q+6,6)local s=date("%I:00 %p",time()+n+1)if k=='m'or k=='mar'then q=7 end;if k=='n'or k=='next'then q=r end;h=tostring(f[q])local t="#"..g[q][1].." "..g[q][2].." "..g[q][3].." "..h;local u="|cffffff00|Hworldmap:"..g[q][1]..":"..g[q][2]*100 ..":"..g[q][3]*100 .."|h[|A:Waypoint-MapPin-ChatIcon:13:13:0:0|a "..h.."]|h|r"local function v()if l then SlashCmdList.TOMTOM_WAY(t)else DEFAULT_CHAT_FRAME:AddMessage(u)end end;local w="|cffff8800**[TomTom] not enabled/detected-FFT will use map pins**|r"if k==''or i>0 then if i>0 then print("|cffddaaffFF Today: [offset="..i.."]|r")else print("|cffddaaffFF Today:|r")end;print("|cffddddff "..h..". Reset ["..s.."] in "..o.."|r")end;if k=='c'then print(FisherFriendToday:TimeLeft(SecondsToTime(FisherFriendToday.TimerOne)))print(FisherFriendToday:TimeLeft(SecondsToTime(FisherFriendToday.TimerTwo)))end;if k=='p'or k=='pin'then DEFAULT_CHAT_FRAME:AddMessage(u)end;if k=='w'or k=='way'or k=='m'or k=='mar'then v()end;if k=='n'or k=='next'then h="|cffaaddffNext: |r"..h;print("|cffaaddffFF "..h.."|r")v()end;if k=='?'or k=='help'then print("|cffccffcc                 ===FFT===|r")if not l then print(w)end;print("|cffffcccc/fft|r -prints the current Fisherfriend and reset time|r")print("|cffffcccc/fft p / pin|r -map pin link for current Fisherfriend|r")print("|cffffcccc/fft w / way|r -set waypoint for current Fisherfriend|r")print("|cffffcccc/fft n / next|r -set waypoint for the next Fisherfriend|r")print("|cffffcccc/fft m / mar|r -set waypoint for Margoss|r")print("|cffffcc88/ffto or /ffts -Open the setting page|r")print("|cffaacccc/fft a       -announcment for current Fisherfriend|r")print("|Cffff88ff/rl          -Reload interface|r")end;if k=='a'then RaidNotice_AddMessage(RaidWarningFrame,"FF Today: "..h..". Reset ["..s.."]",ChatTypeInfo["RAID_WARNING"])end;globqrt=n end;SlashCmdList["FFT"]=j;SLASH_RL1="/rl"SlashCmdList["RL"]=function()ReloadUI()end;local function x()function FisherFriendToday:OnEnable()if c:GetOption('announce')then j("a")end;j("")FisherFriendToday.TimerOne=FisherFriendToday:ScheduleTimer("TimerFeedback",globqrt+5)end;local y=a:NewDataObject("FisherFriendToday",{type="data source",icon="Interface\\Icons\\Inv_misc_2h_draenorfishingpole_b_01",OnClick=function(z,A)if A=="LeftButton"then if IsShiftKeyDown()then j("m")else if IsControlKeyDown()then else j("w")end end else j("n")end end,label="FFT",text="FisherFriendToday"})local B=CreateFrame("frame")B:SetScript("OnUpdate",function(self,C)y.text=" "..h end)function y:OnTooltipShow()self:AddLine("Left click for current FFT waypoint")self:AddLine("Shift + Left click for Margoss")self:AddLine("Right click for next FFT waypoint")self:AddLine("|cffffcc88 /ffto for options|r")self:AddLine("|cffcccc88 /fft ? for help|r")end;function y:OnEnter()GameTooltip:SetOwner(self,"ANCHOR_NONE")GameTooltip:SetPoint("TOPLEFT",self,"BOTTOMLEFT")GameTooltip:ClearLines()y.OnTooltipShow(GameTooltip)GameTooltip:Show()end;function y:OnLeave()GameTooltip:Hide()end end;x()function FisherFriendToday:TimerFeedback()print("Reset detected : New FisherFriendToday")j("")FisherFriendToday.timerCount=0;FisherFriendToday.TimerTwo=FisherFriendToday:ScheduleRepeatingTimer("TimerFeedbackTwo",86400)end;function FisherFriendToday:TimerFeedbackTwo()print("Another Reset detected : New FisherFriendToday")j()FisherFriendToday.timerCount=FisherFriendToday.timerCount+1;if FisherFriendToday.timerCount==6 then FisherFriendToday:CancelTimer(FisherFriendToday.TimerTwo)end end